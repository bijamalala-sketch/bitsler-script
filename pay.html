<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Payment</title>
<link rel="stylesheet" href="style.css">

<!-- QRCode.js pour générer le QR côté client -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
<div class="container center">

  <h1 id="cryptoName">Payment</h1>

  <p><strong>Order ID:</strong> <span id="orderId"></span></p>
  <p><strong>Email:</strong> <span id="emailClient"></span></p>

  <div id="amountCrypto" class="price"></div>

  <p><strong>Send to this address:</strong></p>
  <div class="box" id="walletAddress"></div>

  <button class="btn" onclick="copyAddress()">Copy address</button>

  <p><strong>Scan QR code:</strong></p>
  <div id="qrCode" style="width:180px;height:180px;margin:auto;"></div>

  <p id="networkInfo"></p>

  <p class="timer red">
    Time remaining: <span id="timer">15:00</span>
  </p>

</div>

<script>
// ===================== CONFIG =====================
const PRICE_USD = 10;
const EXPIRATION_MINUTES = 15;

const wallets = {
  BTC: { address: "1B4GpRC6A2tWiVAqqb9cCEJNyGHmZK6Uf4", network: "Bitcoin", pair: "BTC-USD" },
  ETH: { address: "0xb0896309e10d52c6925179a7426f3d642db096db", network: "Ethereum", pair: "ETH-USD" },
  LTC: { address: "LNZBEueQ14NRHoD1RYMiJpFUxFmnfXUDZN", network: "Litecoin", pair: "LTC-USD" },
  DOGE:{ address: "D6oCyXEUXwh2yHHp43WZWqjGMJNgP5dC6A", network: "Dogecoin", pair: "DOGE-USD" },
  USDT_TRON:{ address: "TJbd8B6dGaYYuhwRXAMppxDnYKanXHWirQ", network: "TRC20", fixed: true },
  USDT_BEP20:{ address: "0xb0896309e10d52c6925179a7426f3d642db096db", network: "BEP20", fixed: true }
};

// ===================== UTILS =====================
function generateOrderId(){
  return "ORD-"+Date.now()+"-"+Math.random().toString(36).substring(2,7);
}

async function getCryptoAmount(crypto){
  if(wallets[crypto].fixed) return PRICE_USD.toFixed(2);
  try{
    const r = await fetch(`https://api.coinbase.com/v2/prices/${wallets[crypto].pair}/spot`);
    const d = await r.json();
    return (PRICE_USD / d.data.amount).toFixed(8);
  }catch{
    return PRICE_USD; // fallback si API ne répond pas
  }
}

// ===================== MAIN =====================
(async function(){
  const params = new URLSearchParams(window.location.search);
  const crypto = params.get("c");
  const email = params.get("e");

  if(!crypto || !wallets[crypto] || !email){
    window.location.href="index.html";
    return;
  }

  const orderId = generateOrderId();

  // Elements DOM
  const cEl = document.getElementById("cryptoName");
  const oidEl = document.getElementById("orderId");
  const emailEl = document.getElementById("emailClient");
  const addrEl = document.getElementById("walletAddress");
  const netEl = document.getElementById("networkInfo");
  const amtEl = document.getElementById("amountCrypto");
  const timerEl = document.getElementById("timer");
  const qrEl = document.getElementById("qrCode");

  // Affichage infos
  cEl.textContent = crypto + " Payment";
  oidEl.textContent = orderId;
  emailEl.textContent = email;
  addrEl.textContent = wallets[crypto].address;
  netEl.textContent = "Network: " + wallets[crypto].network;

  // Montant en crypto
  const amount = await getCryptoAmount(crypto);
  amtEl.textContent = `Send exactly ${amount} ${crypto}`;

  // QR CODE
  qrEl.innerHTML = "";
  new QRCode(qrEl, { text: wallets[crypto].address, width:180, height:180 });

  // TIMER
  let seconds = EXPIRATION_MINUTES * 60;
  const interval = setInterval(()=>{
    const m = Math.floor(seconds/60);
    const s = seconds%60;
    timerEl.textContent = `${m}:${s.toString().padStart(2,"0")}`;
    seconds--;
    if(seconds < 0){
      clearInterval(interval);
      window.location.href="expired.html";
    }
  },1000);

})();

// ===================== COPY ADDRESS =====================
function copyAddress(){
  const addr = document.getElementById("walletAddress").textContent;
  navigator.clipboard.writeText(addr);
  alert("Wallet address copied!");
}
</script>

</body>
</html>
